import React, { useState } from 'react';
import { ChevronRight, ChevronLeft, CheckCircle, RefreshCw, Award, BookOpen, User, School, Mail, PlayCircle } from 'lucide-react';

// --- DATA SOAL ---
const QUESTIONS = [
  // --- UNIT 1: BILANGAN ---
  {
    id: 1,
    category: "Bilangan & Operasi",
    type: "single",
    question: "Hitunglah hasil dari operasi berikut: 8 + (-12)",
    options: [
      { text: "20", isCorrect: false },
      { text: "4", isCorrect: false },
      { text: "-4", isCorrect: true },
      { text: "-20", isCorrect: false }
    ]
  },
  {
    id: 2,
    category: "Bilangan & Operasi",
    type: "complex",
    question: "Manakah dari pernyataan berikut yang BENAR mengenai KPK (Kelipatan Persekutuan Terkecil) dan FPB (Faktor Persekutuan Terbesar)? (Pilih lebih dari satu)",
    options: [
      { text: "KPK dari 6 dan 10 adalah 30", isCorrect: true },
      { text: "FPB dari 24 dan 40 adalah 8", isCorrect: true },
      { text: "KPK dari 6 dan 10 adalah 60", isCorrect: false },
      { text: "FPB dari 24 dan 40 adalah 4", isCorrect: false }
    ]
  },
  {
    id: 3,
    category: "Bilangan & Operasi",
    type: "single",
    question: "Berapakah hasil dari ∛125 - ∛27 ? (Akar pangkat tiga dari 125 dikurang akar pangkat tiga dari 27)",
    options: [
      { text: "2", isCorrect: true },
      { text: "3", isCorrect: false },
      { text: "5", isCorrect: false },
      { text: "8", isCorrect: false }
    ]
  },
  {
    id: 4,
    category: "Bilangan & Operasi",
    type: "single",
    question: "Sebuah bilangan 3*58 memiliki satu digit yang hilang (*). Agar bilangan tersebut habis dibagi 3, angka berapakah yang mungkin menggantikan *?",
    options: [
      { text: "1", isCorrect: false },
      { text: "2", isCorrect: true },
      { text: "3", isCorrect: false },
      { text: "4", isCorrect: false }
    ]
  },
  {
    id: 5,
    category: "Bilangan & Operasi",
    type: "single",
    question: "Hasil kali dua bilangan bulat adalah -24. Jumlah kedua bilangan tersebut adalah 5. Berapakah kedua bilangan itu?",
    options: [
      { text: "8 dan -3", isCorrect: true },
      { text: "-8 dan 3", isCorrect: false },
      { text: "6 dan -4", isCorrect: false },
      { text: "12 dan -2", isCorrect: false }
    ]
  },
  {
    id: 6,
    category: "Bilangan & Operasi",
    type: "complex",
    question: "Diketahui pola bilangan kuadrat: 2² = 4, 4² = 16, 8² = 64. Manakah pernyataan yang benar tentang 32²? (Pilih lebih dari satu)",
    options: [
      { text: "Nilainya adalah 1024", isCorrect: true },
      { text: "Nilainya sama dengan (2^5)²", isCorrect: true },
      { text: "Nilainya adalah 900", isCorrect: false },
      { text: "Nilainya lebih kecil dari 30²", isCorrect: false }
    ]
  },

  // --- UNIT 2: ALJABAR ---
  {
    id: 7,
    category: "Aljabar",
    type: "single",
    question: "Jika p = 3 dan q = 10, berapakah nilai dari ekspresi 5q - 1?",
    options: [
      { text: "14", isCorrect: false },
      { text: "49", isCorrect: true },
      { text: "51", isCorrect: false },
      { text: "29", isCorrect: false }
    ]
  },
  {
    id: 8,
    category: "Aljabar",
    type: "single",
    question: "Sederhanakan bentuk aljabar berikut: 4ab - 3ba + 7rs - 7sr",
    options: [
      { text: "ab", isCorrect: true },
      { text: "7ab + 14rs", isCorrect: false },
      { text: "ab + 14rs", isCorrect: false },
      { text: "7ab", isCorrect: false }
    ]
  },
  {
    id: 9,
    category: "Aljabar",
    type: "complex",
    question: "Manakah penyederhanaan yang BENAR? (Pilih lebih dari satu)",
    options: [
      { text: "9p + p = 10p", isCorrect: true },
      { text: "3x + 9 = 12x", isCorrect: false },
      { text: "5(p - 2) = 5p - 10", isCorrect: true },
      { text: "6p - 5p = 1", isCorrect: false }
    ]
  },
  {
    id: 10,
    category: "Aljabar",
    type: "single",
    question: "Selesaikan persamaan berikut: x - 8 = 22",
    options: [
      { text: "x = 14", isCorrect: false },
      { text: "x = 30", isCorrect: true },
      { text: "x = 176", isCorrect: false },
      { text: "x = 2.75", isCorrect: false }
    ]
  },
  {
    id: 11,
    category: "Aljabar",
    type: "single",
    question: "Untuk pertidaksamaan n > 8, manakah bilangan bulat TERKECIL yang memenuhi?",
    options: [
      { text: "8", isCorrect: false },
      { text: "9", isCorrect: true },
      { text: "7", isCorrect: false },
      { text: "8.1", isCorrect: false }
    ]
  },
  {
    id: 12,
    category: "Aljabar",
    type: "single",
    question: "Sederhanakan pecahan aljabar berikut: 3x/4 + 7x/12",
    options: [
      { text: "10x/16", isCorrect: false },
      { text: "4x/3", isCorrect: true },
      { text: "10x/12", isCorrect: false },
      { text: "x", isCorrect: false }
    ]
  },
  {
    id: 13,
    category: "Aljabar",
    type: "complex",
    question: "Manakah dari berikut ini yang merupakan ekspresi (bukan persamaan)? (Pilih lebih dari satu)",
    options: [
      { text: "3x + 9", isCorrect: true },
      { text: "3x + 9 = 12", isCorrect: false },
      { text: "4(d + 3r)", isCorrect: true },
      { text: "x = 5", isCorrect: false }
    ]
  },
  {
    id: 14,
    category: "Aljabar",
    type: "single",
    question: "Sebuah segitiga sama kaki memiliki panjang sisi yang sama sebesar (4x - 7) cm. Jika salah satu sisi tersebut panjangnya 25 cm, berapakah nilai x?",
    options: [
      { text: "4.5", isCorrect: false },
      { text: "8", isCorrect: true },
      { text: "32", isCorrect: false },
      { text: "18", isCorrect: false }
    ]
  },

  // --- UNIT 3: DESIMAL & PANGKAT ---
  {
    id: 15,
    category: "Desimal & Nilai Tempat",
    type: "single",
    question: "Hitunglah: 35.8 × 10⁴",
    options: [
      { text: "358.000", isCorrect: true },
      { text: "3.580.000", isCorrect: false },
      { text: "35.800", isCorrect: false },
      { text: "0,00358", isCorrect: false }
    ]
  },
  {
    id: 16,
    category: "Desimal & Nilai Tempat",
    type: "single",
    question: "Hitunglah: 3210 ÷ 10⁴",
    options: [
      { text: "32.100.000", isCorrect: false },
      { text: "3,21", isCorrect: false },
      { text: "0,321", isCorrect: true },
      { text: "0,0321", isCorrect: false }
    ]
  },
  {
    id: 17,
    category: "Desimal & Nilai Tempat",
    type: "complex",
    question: "Manakah pembulatan yang BENAR? (Pilih lebih dari satu)",
    options: [
      { text: "16,952 dibulatkan ke 2 desimal menjadi 16,95", isCorrect: true },
      { text: "7,9986 dibulatkan ke 2 desimal menjadi 8,00", isCorrect: true },
      { text: "813,0298 dibulatkan ke 3 desimal menjadi 813,029", isCorrect: false },
      { text: "449,5678 dibulatkan ke 4 desimal menjadi 449,5680", isCorrect: false }
    ]
  },
  {
    id: 18,
    category: "Desimal & Nilai Tempat",
    type: "single",
    question: "Tuliskan 10.000.000 sebagai bilangan berpangkat basis 10.",
    options: [
      { text: "10^6", isCorrect: false },
      { text: "10^7", isCorrect: true },
      { text: "10^8", isCorrect: false },
      { text: "10^5", isCorrect: false }
    ]
  },
  {
    id: 19,
    category: "Desimal & Nilai Tempat",
    type: "complex",
    question: "Manakah pernyataan yang benar tentang perpangkatan 10? (Pilih lebih dari satu)",
    options: [
      { text: "Membagi dengan 10² sama dengan menggeser koma desimal 2 langkah ke kiri", isCorrect: true },
      { text: "54 × 10² = 5400", isCorrect: true },
      { text: "10³ adalah seribu", isCorrect: true },
      { text: "Mengalikan dengan 10³ membuat bilangan menjadi lebih kecil", isCorrect: false }
    ]
  },
  {
    id: 20,
    category: "Desimal & Nilai Tempat",
    type: "single",
    question: "Bulatkan 813,02981 ke 3 tempat desimal.",
    options: [
      { text: "813,029", isCorrect: false },
      { text: "813,030", isCorrect: true },
      { text: "813,028", isCorrect: false },
      { text: "813,03", isCorrect: false }
    ]
  }
];

export default function MathQuizApp() {
  const [appState, setAppState] = useState('registration'); // 'registration', 'quiz', 'result'
  const [studentInfo, setStudentInfo] = useState({
    name: '',
    className: '',
    email: ''
  });
  
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [userAnswers, setUserAnswers] = useState({}); 

  // --- Handlers ---

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setStudentInfo(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const startQuiz = (e) => {
    e.preventDefault();
    if (studentInfo.name && studentInfo.className) {
      setAppState('quiz');
    } else {
      alert("Mohon lengkapi Nama dan Kelas terlebih dahulu.");
    }
  };

  const handleOptionSelect = (qId, optionIndex, type) => {
    setUserAnswers(prev => {
      const currentSelection = prev[qId] || [];
      
      if (type === 'single') {
        return { ...prev, [qId]: [optionIndex] };
      } else {
        if (currentSelection.includes(optionIndex)) {
          return { ...prev, [qId]: currentSelection.filter(i => i !== optionIndex) };
        } else {
          return { ...prev, [qId]: [...currentSelection, optionIndex] };
        }
      }
    });
  };

  const calculateScore = () => {
    let totalScore = 0;
    let maxScore = QUESTIONS.length;
    let categoryScores = {};

    QUESTIONS.forEach(q => {
      if (!categoryScores[q.category]) {
        categoryScores[q.category] = { correct: 0, total: 0 };
      }
      categoryScores[q.category].total += 1;

      const userAns = userAnswers[q.id] || [];
      
      let isCorrect = false;
      if (q.type === 'single') {
        if (userAns.length > 0 && q.options[userAns[0]].isCorrect) {
          isCorrect = true;
        }
      } else {
        const correctIndices = q.options.map((opt, idx) => opt.isCorrect ? idx : -1).filter(i => i !== -1);
        const userIndices = userAns.sort();
        
        const isAllCorrectSelected = correctIndices.every(i => userIndices.includes(i));
        const isNoWrongSelected = userIndices.every(i => correctIndices.includes(i));
        
        if (isAllCorrectSelected && isNoWrongSelected && correctIndices.length === userIndices.length) {
          isCorrect = true;
        }
      }

      if (isCorrect) {
        totalScore += 1;
        categoryScores[q.category].correct += 1;
      }
    });

    return { totalScore, maxScore, categoryScores };
  };

  const resetQuiz = () => {
    setUserAnswers({});
    setCurrentQuestionIndex(0);
    setAppState('registration');
    setStudentInfo({ name: '', className: '', email: '' });
  };

  // --- RENDERING ---

  // 1. TAMPILAN REGISTRASI
  if (appState === 'registration') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
          <div className="text-center mb-8">
            <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <BookOpen className="w-8 h-8 text-blue-600" />
            </div>
            <h1 className="text-2xl font-bold text-gray-800">Selamat Datang!</h1>
            <p className="text-gray-500">Silakan isi data diri sebelum memulai kuis Matematika.</p>
          </div>

          <form onSubmit={startQuiz} className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <User className="h-5 w-5 text-gray-400" />
                </div>
                <input
                  type="text"
                  name="name"
                  required
                  value={studentInfo.name}
                  onChange={handleInputChange}
                  className="pl-10 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                  placeholder="Masukkan nama lengkap"
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <School className="h-5 w-5 text-gray-400" />
                </div>
                <input
                  type="text"
                  name="className"
                  required
                  value={studentInfo.className}
                  onChange={handleInputChange}
                  className="pl-10 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                  placeholder="Contoh: 7A"
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Email (Opsional)</label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Mail className="h-5 w-5 text-gray-400" />
                </div>
                <input
                  type="email"
                  name="email"
                  value={studentInfo.email}
                  onChange={handleInputChange}
                  className="pl-10 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                  placeholder="nama@sekolah.com"
                />
              </div>
            </div>

            <button
              type="submit"
              className="w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all transform hover:scale-[1.02] shadow-md mt-6"
            >
              Mulai Mengerjakan
              <PlayCircle className="ml-2 w-5 h-5" />
            </button>
          </form>
        </div>
      </div>
    );
  }

  // 2. TAMPILAN HASIL
  if (appState === 'result') {
    const { totalScore, maxScore, categoryScores } = calculateScore();
    const percentage = Math.round((totalScore / maxScore) * 100);
    
    const strengths = [];
    const weaknesses = [];
    
    Object.keys(categoryScores).forEach(cat => {
      const score = categoryScores[cat];
      const catPercent = (score.correct / score.total) * 100;
      if (catPercent >= 70) strengths.push(`${cat} (${Math.round(catPercent)}%)`);
      else weaknesses.push(`${cat} (${Math.round(catPercent)}%)`);
    });

    return (
      <div className="min-h-screen bg-gray-50 p-4 md:p-8 font-sans text-gray-800">
        <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
          <div className="bg-blue-600 p-6 text-white">
            <h1 className="text-3xl font-bold mb-2 text-center">Laporan Hasil Evaluasi</h1>
            <div className="bg-blue-700 bg-opacity-30 rounded-lg p-4 mt-4 flex justify-between items-center text-sm md:text-base">
              <div>
                <p className="opacity-80">Nama Siswa</p>
                <p className="font-bold text-lg">{studentInfo.name}</p>
              </div>
              <div className="text-right">
                <p className="opacity-80">Kelas</p>
                <p className="font-bold text-lg">{studentInfo.className}</p>
              </div>
            </div>
            {studentInfo.email && (
              <p className="text-center mt-2 text-xs opacity-70">Hasil dikirim ke: {studentInfo.email}</p>
            )}
          </div>
          
          <div className="p-8">
            <div className="flex flex-col items-center justify-center mb-8">
              <div className="relative w-32 h-32 flex items-center justify-center rounded-full border-4 border-blue-500 mb-4">
                <span className="text-4xl font-bold text-blue-600">{percentage}%</span>
              </div>
              <p className="text-xl font-semibold text-gray-700">Skor: {totalScore} / {maxScore}</p>
            </div>

            <div className="grid md:grid-cols-2 gap-6 mb-8">
              <div className="bg-green-50 p-4 rounded-lg border border-green-100">
                <div className="flex items-center mb-3 text-green-700">
                  <Award className="w-5 h-5 mr-2" />
                  <h3 className="font-bold">Perlu Dipertahankan</h3>
                </div>
                {strengths.length > 0 ? (
                  <ul className="list-disc list-inside text-sm text-green-800">
                    {strengths.map(s => <li key={s}>{s}</li>)}
                  </ul>
                ) : (
                  <p className="text-sm text-gray-500 italic">Terus berlatih untuk meningkatkan semua area.</p>
                )}
              </div>

              <div className="bg-orange-50 p-4 rounded-lg border border-orange-100">
                <div className="flex items-center mb-3 text-orange-700">
                  <BookOpen className="w-5 h-5 mr-2" />
                  <h3 className="font-bold">Perlu Diperkuat</h3>
                </div>
                {weaknesses.length > 0 ? (
                  <ul className="list-disc list-inside text-sm text-orange-800">
                    {weaknesses.map(w => <li key={w}>{w}</li>)}
                  </ul>
                ) : (
                  <p className="text-sm text-gray-500 italic">Kerja bagus! Pertahankan prestasi ini.</p>
                )}
              </div>
            </div>

            <button 
              onClick={resetQuiz}
              className="w-full flex items-center justify-center py-3 px-6 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors"
            >
              <RefreshCw className="w-5 h-5 mr-2" />
              Selesai / Kerjakan Ulang
            </button>
          </div>
        </div>
      </div>
    );
  }

  // 3. TAMPILAN KUIS (MAIN)
  const currentQ = QUESTIONS[currentQuestionIndex];
  const selectedOpts = userAnswers[currentQ.id] || [];
  const progress = ((currentQuestionIndex + 1) / QUESTIONS.length) * 100;
  
  return (
    <div className="min-h-screen bg-gray-100 p-4 md:p-8 font-sans text-gray-800">
      <div className="max-w-3xl mx-auto">
        {/* Header / Info Siswa Mini */}
        <div className="mb-6 flex flex-col md:flex-row md:justify-between md:items-end gap-2">
          <div>
            <h2 className="text-2xl font-bold text-gray-800">Kuis Matematika</h2>
            <p className="text-gray-500 text-sm">Siswa: <span className="font-semibold text-gray-700">{studentInfo.name} ({studentInfo.className})</span></p>
          </div>
          <span className="text-blue-600 font-bold bg-blue-100 px-3 py-1 rounded-full text-sm w-fit">
            Soal {currentQuestionIndex + 1}/{QUESTIONS.length}
          </span>
        </div>

        {/* Progress Bar */}
        <div className="w-full bg-gray-300 rounded-full h-2.5 mb-6">
          <div className="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style={{ width: `${progress}%` }}></div>
        </div>

        {/* Card Soal */}
        <div className="bg-white rounded-xl shadow-md p-6 md:p-8 min-h-[400px] flex flex-col">
          <div className="mb-4">
            <span className={`inline-block px-2 py-1 text-xs font-semibold rounded uppercase tracking-wide ${
              currentQ.type === 'complex' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'
            }`}>
              {currentQ.type === 'complex' ? 'Pilihan Ganda Kompleks (Pilih > 1)' : 'Pilihan Ganda Tunggal'}
            </span>
            <span className="ml-2 inline-block px-2 py-1 text-xs font-semibold bg-gray-100 text-gray-600 rounded uppercase tracking-wide">
              {currentQ.category}
            </span>
          </div>

          <h3 className="text-xl font-medium mb-6 leading-relaxed">
            {currentQ.question}
          </h3>

          <div className="space-y-3 flex-grow">
            {currentQ.options.map((opt, idx) => {
              const isSelected = selectedOpts.includes(idx);
              return (
                <button
                  key={idx}
                  onClick={() => handleOptionSelect(currentQ.id, idx, currentQ.type)}
                  className={`w-full text-left p-4 rounded-lg border-2 transition-all flex items-center group ${
                    isSelected 
                      ? 'border-blue-500 bg-blue-50' 
                      : 'border-gray-200 hover:border-blue-300 hover:bg-gray-50'
                  }`}
                >
                  <div className={`w-6 h-6 rounded flex items-center justify-center mr-4 border ${
                    currentQ.type === 'single' ? 'rounded-full' : 'rounded-md'
                  } ${
                    isSelected ? 'bg-blue-500 border-blue-500' : 'border-gray-400 bg-white'
                  }`}>
                    {isSelected && <div className="w-2.5 h-2.5 bg-white rounded-full" />}
                  </div>
                  <span className={`${isSelected ? 'text-blue-900 font-medium' : 'text-gray-700'}`}>
                    {opt.text}
                  </span>
                </button>
              );
            })}
          </div>
        </div>

        {/* Navigation */}
        <div className="flex justify-between mt-8">
          <button
            onClick={() => setCurrentQuestionIndex(prev => Math.max(0, prev - 1))}
            disabled={currentQuestionIndex === 0}
            className={`flex items-center px-6 py-3 rounded-lg font-medium transition-colors ${
              currentQuestionIndex === 0 
                ? 'text-gray-400 cursor-not-allowed bg-gray-200' 
                : 'text-gray-700 bg-white hover:bg-gray-50 shadow-sm'
            }`}
          >
            <ChevronLeft className="w-5 h-5 mr-2" />
            Sebelumnya
          </button>

          {currentQuestionIndex === QUESTIONS.length - 1 ? (
            <button
              onClick={() => setAppState('result')}
              className="flex items-center px-8 py-3 rounded-lg bg-green-600 text-white font-bold hover:bg-green-700 shadow-lg transition-transform hover:scale-105"
            >
              Selesai & Lihat Skor
              <CheckCircle className="w-5 h-5 ml-2" />
            </button>
          ) : (
            <button
              onClick={() => setCurrentQuestionIndex(prev => Math.min(QUESTIONS.length - 1, prev + 1))}
              className="flex items-center px-6 py-3 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 shadow-md transition-colors"
            >
              Selanjutnya
              <ChevronRight className="w-5 h-5 ml-2" />
            </button>
          )}
        </div>
      </div>
    </div>
  );
}
